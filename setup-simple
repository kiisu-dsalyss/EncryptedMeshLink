#!/bin/bash

# EncryptedMeshLink - Super Simple Setup for Beta Testers
# One command: curl -fsSL https://raw.githubusercontent.com/kiisu-dsalyss/EncryptedMeshLink/master/setup-simple | bash

set -e

echo "ğŸš€ EncryptedMeshLink Simple Setup"
echo "================================="
echo ""

# Check if running on supported architecture
ARCH=$(uname -m)
case $ARCH in
    aarch64|arm64|armv7l)
        echo "âœ… ARM architecture detected: $ARCH"
        ;;
    x86_64)
        echo "âœ… x86_64 architecture detected"
        ;;
    *)
        echo "âŒ Unsupported architecture: $ARCH"
        exit 1
        ;;
esac

# Function to install Docker if needed
install_docker() {
    echo "ğŸ“¦ Installing Docker..."
    curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
    sudo sh /tmp/get-docker.sh
    sudo usermod -aG docker $USER
    rm -f /tmp/get-docker.sh
    echo "âœ… Docker installed!"
}

# Check Docker installation
if ! command -v docker &> /dev/null; then
    install_docker
    echo ""
    echo "ğŸ”„ Docker installed but requires group activation."
    echo "   Restarting setup with proper permissions..."
    echo ""
    # Re-run this script with sg docker to activate group
    exec sg docker -c "bash <(curl -fsSL https://raw.githubusercontent.com/kiisu-dsalyss/EncryptedMeshLink/master/setup-simple)"
fi

# Test Docker access
if ! docker info &> /dev/null; then
    echo "âš ï¸  Docker installed but not accessible. Trying group activation..."
    if groups | grep -q docker; then
        echo "ğŸ”§ Docker group detected, but daemon may not be running."
        sudo systemctl start docker
        sudo systemctl enable docker
        sleep 3
    else
        echo "âŒ Docker group not active. Please run:"
        echo "   newgrp docker"
        echo "   Then re-run this setup script."
        exit 1
    fi
    
    # Test again
    if ! docker info &> /dev/null; then
        echo "âŒ Still can't access Docker. Please:"
        echo "   1. Log out and log back in"
        echo "   2. Or run: newgrp docker"
        echo "   3. Then re-run this setup"
        exit 1
    fi
fi

echo "âœ… Docker is ready!"

# Install Docker Compose if needed
if ! docker compose version &> /dev/null && ! command -v docker-compose &> /dev/null; then
    echo "ğŸ“¦ Installing Docker Compose..."
    sudo apt update
    sudo apt install -y docker-compose-plugin
fi

# Set up project
PROJECT_DIR="$HOME/encryptedmeshlink"
echo "ğŸ“ Setting up in: $PROJECT_DIR"

mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR"

# Download the quick deploy script
echo "ğŸ“¥ Downloading deployment script..."
curl -fsSL https://raw.githubusercontent.com/kiisu-dsalyss/EncryptedMeshLink/master/scripts/quick-deploy-pi.sh -o deploy.sh
chmod +x deploy.sh

# Run the deployment (it will skip Docker installation since we already did it)
echo "ğŸš€ Running deployment..."
./deploy.sh

echo ""
echo "ğŸ‰ Setup complete! EncryptedMeshLink should now be running."
echo "ğŸ“ Project files are in: $PROJECT_DIR"
echo ""
